# Gobang Game (五子棋游戏)

## 中文介绍

### 项目概述
这是一个基于Python和pygame的网络五子棋游戏项目，支持两人通过局域网进行实时对战。该项目实现了完整的五子棋游戏逻辑，包括网络连接、聊天功能、声音效果、玩家统计等功能。项目主要使用pygame作为图形界面库，但由于pygame在UI组件方面的局限性，开发者不得不自行实现大量的UI组件。

### 功能列表
1. **网络对战功能**：
   - 支持局域网内玩家发现和连接
   - 使用UDP广播协议自动发现可用房间
   - 实时同步游戏状态和玩家操作

2. **游戏核心逻辑**：
   - 标准五子棋规则实现（15x15棋盘）
   - 自动胜负判断（五子连珠或满盘平局）
   - 轮流落子机制

3. **聊天系统**：
   - 实时文本聊天功能
   - 支持玩家间消息发送
   - 聊天记录显示和滚动

4. **声音控制**：
   - 背景音乐播放
   - 落子音效
   - 胜负音效（胜利、失败、平局）
   - 音量控制开关

5. **计时器系统**：
   - 每步操作时间限制
   - 超时自动判负
   - 实时倒计时显示

6. **玩家资料系统**：
   - 玩家统计数据（胜率、连胜记录等）
   - 游戏历史记录
   - 个人资料管理（使用tkinter界面）

7. **自定义UI组件**：
   - 按钮、输入框、对话框等组件
   - 圆形头像裁剪功能
   - 响应式界面设计

### 网络架构和自定义沟通协议
**网络架构**：
- 采用P2P（点对点）架构，无需中央服务器
- 使用UDP协议进行通信，适合实时游戏
- 广播机制用于房间发现

**自定义沟通协议**：
- 消息格式：JSON格式
- 主要消息类型：
  - `lost_ping`：连接保活检测
  - `chat`：聊天消息
  - `move`：落子操作（包含x,y坐标和玩家信息）
  - `win`：游戏结束通知
- 协议特点：
  - 轻量级，易于解析
  - 支持时间戳和玩家标识
  - 包含错误处理和连接丢失检测

### 使用方法
1. **环境准备**：
   - 安装Python 3.x
   - 安装依赖包：`pip install pygame pillow`
   - 确保防火墙允许UDP端口5000通信

2. **启动游戏**：
   - 运行 `python main.py`
   - 在主界面选择"创建房间"或"加入房间"

3. **创建房间**：
   - 设置房间ID、每步时间、选择棋子颜色
   - 等待对方加入

4. **加入房间**：
   - 输入房间ID
   - 自动连接到房间

5. **游戏进行**：
   - 轮流在棋盘上落子
   - 使用聊天框与对手交流
   - 注意时间限制

6. **游戏结束**：
   - 系统自动判断胜负
   - 统计数据自动保存

### 详细游戏流程
以下是完整的游戏流程，从启动到结束的详细描述：

#### 1. 游戏启动阶段
- **程序初始化**：运行 `main.py`，程序首先检查 `player_data/player_data.txt` 文件是否存在
- **玩家数据加载**：如果文件存在，加载玩家ID、统计数据和偏好设置；如果不存在，创建默认玩家数据
- **网络连接初始化**：创建Connection对象，初始化UDP socket，绑定本地端口5000
- **主界面显示**：显示游戏主界面，提供"创建房间"和"加入房间"选项

#### 2. 创建房间流程
- **房间设置对话框**：点击"创建房间"后，弹出设置对话框
  - 输入房间ID（唯一标识符）
  - 设置每步时间限制（默认30秒）
  - 选择棋子颜色（黑棋或白棋）
- **房间验证**：系统检查房间ID是否已被使用，通过UDP广播检测
- **广播房间信息**：如果验证通过，开始UDP广播房间信息，等待其他玩家加入
- **等待状态**：显示"等待对手加入..."界面，同时保持广播

#### 3. 加入房间流程
- **房间搜索**：点击"加入房间"后，程序开始监听UDP广播，搜索可用房间
- **房间列表显示**：显示搜索到的房间列表（如果有）
- **手动输入房间ID**：如果没有搜索到或需要特定房间，可以手动输入房间ID
- **连接建立**：输入房间ID后，程序尝试连接到指定房间
  - 发送连接请求到对方IP和端口
  - 等待对方确认连接
- **连接验证**：双方建立P2P连接，开始连接保活检测（每10秒ping一次）

#### 4. 游戏准备阶段
- **棋盘初始化**：连接建立后，初始化15x15的五子棋棋盘
- **玩家分配**：根据创建房间时的选择，分配黑白棋
  - 创建者通常为黑棋先手
  - 加入者为白棋后手
- **界面切换**：从主界面切换到游戏界面，包括棋盘、聊天框、信息栏
- **计时器启动**：设置每步时间，启动倒计时（从黑棋玩家开始）

#### 5. 游戏进行阶段
- **轮流落子**：
  - 当前玩家在棋盘上点击落子
  - 系统验证落子位置是否有效（不能为空）
  - 落子成功后，通过网络发送 `move` 消息给对方
  - 播放落子音效
- **实时同步**：对方接收到 `move` 消息后，在本地棋盘上显示对方落子
- **胜负检查**：每次落子后，检查是否有五子连珠
  - 检查水平、垂直、对角线四个方向
  - 如果五子连珠，立即结束游戏
  - 如果棋盘满员且无胜者，判定平局
- **聊天功能**：玩家可以随时在聊天框输入消息
  - 发送 `chat` 消息给对方
  - 消息实时显示在聊天记录中
- **计时器管理**：
  - 每步时间倒计时
  - 时间到0时，当前玩家判负
  - 落子后重置对方时间，启动己方倒计时

#### 6. 游戏结束阶段
- **胜负判定**：
  - 五子连珠：连珠玩家获胜
  - 超时：超时玩家判负
  - 满盘：平局
- **结束通知**：发送 `win` 消息通知对方游戏结果
- **音效播放**：根据结果播放胜利/失败/平局音效
- **界面更新**：显示胜负结果，禁用棋盘操作
- **数据保存**：调用 `save_game_data()` 函数保存游戏记录

#### 7. Profile更新阶段
- **统计数据更新**：
  - 游戏总局数 +1
  - 根据结果更新胜/负/平局次数
  - 更新连胜记录（胜利时+1，失败时重置为0）
  - 更新最高连胜记录
  - 累计总移动数和总游戏时间
- **游戏历史记录**：
  - 添加新游戏记录到 `game_history` 列表
  - 记录对手ID、结果、移动数、时间戳
- **数据持久化**：将更新后的数据写入 `player_data/player_data.txt` 文件
- **Profile界面**：玩家可以随时查看个人资料窗口（使用tkinter实现）
  - 显示统计数据
  - 显示游戏历史
  - 管理偏好设置（主题、音效等）

#### 8. 游戏重启或退出
- **继续游戏**：玩家可以选择创建新房间或加入其他房间
- **退出游戏**：关闭程序，保存最终数据
- **连接断开**：如果网络连接丢失，显示断开提示，返回主界面

整个流程体现了P2P网络架构的特点：去中心化、无需服务器、直接点对点通信。同时，详细的计时器和统计系统增强了游戏的竞技性和数据追踪功能。

### 第三方Python包
- **pygame**：游戏图形界面和事件处理
- **pillow (PIL)**：图像处理（头像裁剪等）

### 关于pygame的吐槽
这个项目虽然主要由pygame实现，但pygame作为游戏开发库，对开发者来说有着巨大的不便之处：

1. **UI组件匮乏**：pygame没有内置的UI组件库，导致开发者不得不从零开始实现按钮、输入框、对话框等基本组件。这极大地增加了开发时间和复杂度。

2. **事件处理复杂**：pygame的事件系统相对底层，需要手动处理鼠标、键盘事件，缺乏高级的UI事件抽象。

3. **布局管理困难**：没有现成的布局管理器，需要手动计算坐标和尺寸，响应式设计变得异常复杂。

4. **文本渲染局限**：文本渲染功能基本，但多行文本、富文本等高级功能需要大量额外代码。

5. **跨平台一致性**：虽然pygame支持跨平台，但在不同系统上表现可能有差异。

正因为这些不便，我在这个项目中实现了大量的自定义UI组件，包括Button、InputBox、Dialog等类，这些组件在UIComponents.py文件中定义。虽然这提高了代码的可重用性，但也反映了pygame在现代GUI开发中的不足。

### 请求建议和bug报告
欢迎各位开发者对这个项目提出建议和报告bug！代码中可能存在许多不足之处。

**建议渠道**：
- 在GitHub的Issues页面提交问题
- 可以通过Pull Request贡献代码改进

**特别希望得到的建议**：
- 网络协议的安全性改进
- 代码结构优化
- UI/UX改进建议
- 性能优化
- 跨平台兼容性

**已知问题**：
- 网络连接稳定性有待改进
- UI组件在高分辨率屏幕下的适配
- 声音文件的版权问题（当前使用免费音效）

感谢您的关注和支持！